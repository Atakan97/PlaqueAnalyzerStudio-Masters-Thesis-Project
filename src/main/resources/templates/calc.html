<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>PlaqueAnalyzer Studio</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

</head>
<body>

<div class="app-brand">
  <div class="brand-text">
    <span class="brand-name">PlaqueAnalyzer Studio</span>
    <span class="brand-tagline">
      <span class="brand-tagline__scroller">
        <span class="brand-tagline__text">Data Redundancies • Visualization • Database Schema Normalization</span>
      </span>
    </span>
  </div>
</div>
<form id="calcForm"
      th:action="@{/compute}"
      method="post"
      enctype="multipart/form-data">

  <!-- Monte Carlo options - only visible in WITH-PLAQUE mode -->
  <div class="options" th:if="${plaqueMode == null or plaqueMode == 'enabled'}">
    <div class="options-glass-grid">
      <label class="toggle-switch">
        <input type="checkbox" id="mcCheckbox" name="monteCarlo" />
        <span class="toggle-slider"></span>
      </label>
      <div class="toggle-label-container">
        <div class="toggle-label-main">Monte Carlo Approximation</div>
        <div class="toggle-label-sub">Enable Monte Carlo Approximation for faster computation</div>
      </div>
    </div>
    <div class="glass-input-section">
      <div class="glass-input-wrapper">
        <label for="samples">Sample Size:</label>
        <input type="number" id="samples" name="samples" value="100000" disabled />
      </div>
    </div>
  </div>

  <!-- Compute button - text changes based on mode -->
  <div class="compute-btn-wrapper">
    <button type="submit" id="computeBtn" class="compute-btn pill"
            th:text="${plaqueMode == 'disabled' ? 'Start Normalization' : 'Compute Plaque'}">
      Compute Plaque
    </button>
    <p class="hint compute-hint"
       th:text="${plaqueMode == 'disabled' ? 'Prepares data for normalization process.' : 'Runs the relational information content computation.'}">
      Runs the relational information content computation.
    </p>
  </div>

  <div class="input-container">
    <div class="input-column">
      <h2 class="section-heading">Input Data</h2>

      <div id="section-upload" class="tab-content">
        <p class="hint hint--info" style="margin-bottom: 10px;">Note: Upload CSV file or enter data manually.</p>
        <input type="file" id="csvfile" name="csvfile" accept=".csv" />

        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ccc;"> <div id="manual-data-controls">
        <div class="column-controls">
          <label for="columnCountInput">Number of Columns:</label>
          <input type="number" id="columnCountInput" value="3" min="1" max="20" class="small-input">
          <button type="button" id="updateColumnsBtn" class="small">Update Table</button>
        </div>
        <div class="table-actions">
          <button type="button" id="addRow" class="small">+ Add Row</button>
          <button type="button" id="clearManualDataBtn" class="small danger">
            Delete Rows
          </button>
        </div>
        <div class="table-scroll-wrapper">
          <table id="manualDataTable" class="data-grid">
            <thead>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div class="hint hint--info">Note: Column names are written in the first row.</div>
      </div>

      </div>
    </div>

    <div class="input-column">
      <h2 class="section-heading">Functional Dependencies</h2>

      <div id="fd-manual" class="tab-content">
        <p class="hint hint--info" style="margin-bottom: 10px;">Note: Upload CSV file or enter FDs manually.</p>
        <div id="fd-upload-content">
          <input type="file" name="fdfile" id="fdfile" accept=".txt,.csv" />
        </div>

        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ccc;">

        <div class="table-actions">
          <button type="button" id="addFdBtn" class="small">+ Add FD</button>
          <button type="button" id="clearFdRowsBtn" class="small danger">
            Delete Rows
          </button>
        </div>
        <div class="table-scroll-wrapper">
          <table id="fdTable" class="data-grid">
            <thead><tr><th>#</th><th>X</th><th>→</th><th>Y</th><th>Del</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="hint hint--info">Note: Please enter one FD per line, format: X→Y.</div>
        </div>
      </div>
    </div>
  </div>

  <input type="hidden" name="manualData" id="manualData" />
  <input type="hidden" name="fds"        id="fdsInput" />
</form>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script th:src="@{/js/main.js}"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  // Retrieve data to restore from Thymeleaf
  const restoredInputData = /*[[${restoredInputData}]]*/ null;
  const restoredInputDataJson = /*[[${restoredInputDataJson}]]*/ null;
  const restoredFdList = /*[[${restoredFdList}]]*/ null;
  // Plaque mode for conditional UI behavior
  window.plaqueMode = /*[[${plaqueMode}]]*/ 'enabled';
  /*]]>*/


  document.addEventListener('DOMContentLoaded', () => {
    let dataRestored = false;
    let fdRestored = false;

    // Debug logging for restoration
    console.log('[calc.html] Restoration check - restoredInputDataJson:', restoredInputDataJson ? restoredInputDataJson.substring(0, 200) + '...' : 'null');
    console.log('[calc.html] Restoration check - restoredInputData:', restoredInputData ? restoredInputData.substring(0, 200) + '...' : 'null');

    // Restore data and FDs - prefer JSON format if available
    if (restoredInputDataJson && restoredInputDataJson.trim() !== "" && restoredInputDataJson !== "null") {
      try {
        const parsedData = JSON.parse(restoredInputDataJson);
        console.log('[calc.html] Parsed JSON data rows:', parsedData.length, 'First row columns:', parsedData[0]?.length);
        if (Array.isArray(parsedData) && parsedData.length > 0) {
          restoreManualTableFromJson(parsedData);
          dataRestored = true;
          console.log('[calc.html] Data restored from JSON format successfully');
        }
      } catch (e) {
        console.error('[calc.html] Failed to parse restoredInputDataJson:', e);
      }
    }
    // Fallback to legacy format if JSON not available
    if (!dataRestored && restoredInputData && restoredInputData.trim() !== "") {
      console.log('[calc.html] Falling back to legacy format restoration');
      restoreManualTable(restoredInputData);
      dataRestored = true;
    }
    if (restoredFdList && restoredFdList.trim() !== "") {
      restoreFDTable(restoredFdList);
      fdRestored = true;
    }

    // Set table visibility
    // If a restore is done, activate the correct tab
    if (dataRestored) {
      // Ensuring it's active as it's a single tab
      const tabUpload = document.getElementById('tab-upload');
      if (tabUpload) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tabUpload.classList.add('active');
      }
    }

    if (fdRestored) {
      // Manually activate the Enter FD Manually tab (id: tab-fd-manual) and show the section
      const tabFdManual = document.getElementById('tab-fd-manual');
      const sectionFdManual = document.getElementById('fd-manual');
      if (tabFdManual && sectionFdManual) {
        // Remove active class from FD tabs
        document.querySelectorAll('.tab').forEach(t => {
          if (t.id.startsWith('tab-fd-')) {
            t.classList.remove('active');
          }
        });
        // Activate the FD Manual tab
        tabFdManual.classList.add('active');
        sectionFdManual.style.display = 'block';
        // Hide FD Upload
        document.getElementById('fd-upload').style.display = 'none';
      }
    }
  });

  // Restoration functions with full DOM recreation logic
  // Manual Data Table Filling Function
  function restoreManualTable(dataString) {
    // Parse using PapaParse to handle quoted values with commas
    const rowStrings = dataString.split(';');
    if (rowStrings.length < 1) return;

    // Parse each row using PapaParse
    const parsedRows = rowStrings.map(rowStr => {
      const parsed = Papa.parse(rowStr, { header: false });
      return parsed.data && parsed.data[0] ? parsed.data[0] : [];
    }).filter(row => row.length > 0);

    if (parsedRows.length < 1) return;

    const manualDataTable = document.getElementById('manualDataTable');
    const tbody = manualDataTable.querySelector('tbody');
    const thead = manualDataTable.querySelector('thead');
    const columnCountInput = document.getElementById('columnCountInput');

    // Update number of columns based on first row
    const columnCount = parsedRows[0].length;
    if (columnCountInput) {
      columnCountInput.value = columnCount;
    }

    // Rebuild header (following the updateManualTable logic in main.js)
    if (thead) {
      thead.innerHTML = '';
      const headerRow = thead.insertRow();

      for (let i = 0; i < columnCount; i++) {
        const th = document.createElement('th');
        th.textContent = i + 1; // 1, 2, 3...
        headerRow.appendChild(th);
      }
      const delTh = document.createElement('th');
      delTh.textContent = 'Del';
      headerRow.appendChild(delTh);
    }

    // Fill Body
    while(tbody.firstChild) {
      tbody.removeChild(tbody.firstChild);
    }

    // Data rows
    for (let i = 0; i < parsedRows.length; i++) {
      const cells = parsedRows[i];
      const newRow = tbody.insertRow();

      cells.forEach((cellValue) => {
        const newCell = newRow.insertCell();
        newCell.setAttribute('contenteditable', 'true');
        newCell.textContent = cellValue || '';
      });

      // Add row delete button
      const deleteCell = newRow.insertCell();
      deleteCell.innerHTML = '<button type="button" class="delManualRow">×</button>';
    }
  }

  // JSON-based restoration function (avoids semicolon splitting issues)
  function restoreManualTableFromJson(parsedData) {
    if (!Array.isArray(parsedData) || parsedData.length < 1) return;

    const manualDataTable = document.getElementById('manualDataTable');
    const tbody = manualDataTable.querySelector('tbody');
    const thead = manualDataTable.querySelector('thead');
    const columnCountInput = document.getElementById('columnCountInput');

    // Update number of columns based on first row
    const columnCount = parsedData[0].length;
    if (columnCountInput) {
      columnCountInput.value = columnCount;
    }

    // Rebuild header
    if (thead) {
      thead.innerHTML = '';
      const headerRow = thead.insertRow();

      for (let i = 0; i < columnCount; i++) {
        const th = document.createElement('th');
        th.textContent = i + 1; // 1, 2, 3...
        headerRow.appendChild(th);
      }
      const delTh = document.createElement('th');
      delTh.textContent = 'Del';
      headerRow.appendChild(delTh);
    }

    // Fill Body
    while(tbody.firstChild) {
      tbody.removeChild(tbody.firstChild);
    }

    // Data rows - directly use the parsed JSON array
    for (let i = 0; i < parsedData.length; i++) {
      const cells = parsedData[i];
      const newRow = tbody.insertRow();

      // Ensure each row has the expected number of columns
      for (let j = 0; j < columnCount; j++) {
        const newCell = newRow.insertCell();
        newCell.setAttribute('contenteditable', 'true');
        newCell.textContent = (cells && cells[j]) ? cells[j] : '';
      }

      // Add row delete button
      const deleteCell = newRow.insertCell();
      deleteCell.innerHTML = '<button type="button" class="delManualRow">×</button>';
    }
  }

  // FD List Filling Function
  function restoreFDTable(fdString) {
    const fds = fdString.split(';');
    const fdTableBody = document.querySelector('#fdTable tbody');

    if (!fdTableBody) return;

    // Clear existing FDs
    fdTableBody.innerHTML = '';

    // If there is no FD to restore, add a blank line
    if (!fdString || fdString.trim() === '' || fds.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td>1</td>
            <td contenteditable></td>
            <td>→</td>
            <td contenteditable></td>
            <td><button type="button" class="delFd">×</button></td>
        `;
      fdTableBody.appendChild(tr);
      return;
    }

    fds.forEach((fd, index) => {
      const parts = fd.split('->');
      if (parts.length !== 2) return;

      const left = parts[0];
      const right = parts[1];

      const newRow = fdTableBody.insertRow();
      newRow.innerHTML = `
          <td>${index + 1}</td>
          <td contenteditable>${left}</td>
          <td>→</td>
          <td contenteditable>${right}</td>
          <td><button type="button" class="delFd">×</button></td>
        `;
    });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>